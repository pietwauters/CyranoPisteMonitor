<!DOCTYPE html>
<html>

<head>
    <title>Piste Management</title>
    <style>
        body {
            background: #1a1a1a;
            color: #fff;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #2a2a2a;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        h1 {
            margin-top: 0;
            color: #4CAF50;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }

        .nav-links {
            margin: 15px 0;
        }

        .nav-link {
            display: inline-block;
            margin-right: 15px;
            color: #64B5F6;
            text-decoration: none;
        }

        .nav-link:hover {
            text-decoration: underline;
        }

        .connection-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            margin-left: 10px;
        }

        .connection-status.connected {
            background: #4CAF50;
        }

        .connection-status.disconnected {
            background: #f44336;
        }

        .form-section {
            margin: 30px 0;
            padding: 20px;
            background: #333;
            border-radius: 5px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .form-group {
            margin: 15px 0;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #bbb;
            font-weight: bold;
        }

        input,
        select {
            width: 100%;
            padding: 12px;
            background: #444;
            border: 1px solid #555;
            border-radius: 4px;
            color: #fff;
            font-size: 16px;
            box-sizing: border-box;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .fencer-section {
            background: #3a3a3a;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .fencer-section h3 {
            margin-top: 0;
            color: #64B5F6;
        }

        button {
            background: #4CAF50;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            margin: 10px 5px;
            width: 100%;
        }

        button:hover {
            background: #45a049;
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        button.secondary {
            background: #64B5F6;
        }

        button.secondary:hover {
            background: #42A5F5;
        }

        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            display: none;
        }

        .status.success {
            background: #4CAF50;
            display: block;
        }

        .status.error {
            background: #f44336;
            display: block;
        }

        .info-text {
            color: #888;
            font-size: 14px;
            margin-top: 5px;
        }

        .photo-upload-group {
            margin-top: 15px;
            padding: 15px;
            background: #444;
            border-radius: 5px;
        }

        .photo-preview {
            width: 200px;
            height: 250px;
            border: 2px dashed #666;
            border-radius: 5px;
            margin: 10px auto;
            position: relative;
            overflow: hidden;
            background: #222;
            cursor: move;
        }

        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            transform-origin: center center;
            user-select: none;
            -webkit-user-drag: none;
        }

        .photo-preview-empty {
            color: #888;
            text-align: center;
            font-size: 14px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .zoom-controls {
            margin-top: 10px;
        }

        .zoom-controls label {
            display: inline-block;
            margin-right: 10px;
            font-size: 14px;
        }

        .zoom-slider {
            width: 60%;
            vertical-align: middle;
        }

        .zoom-value {
            display: inline-block;
            width: 50px;
            text-align: center;
            color: #aaa;
            font-size: 14px;
        }

        .reset-btn {
            background: #607D8B;
            padding: 5px 15px;
            font-size: 14px;
            margin-left: 10px;
        }

        .reset-btn:hover {
            background: #546E7A;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: block;
            padding: 10px;
            background: #555;
            color: white;
            text-align: center;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }

        .file-input-label:hover {
            background: #666;
        }

        .upload-photo-btn {
            background: #FF9800;
            margin-top: 10px;
        }

        .upload-photo-btn:hover {
            background: #F57C00;
        }

        .upload-photo-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .remove-photo-btn {
            background: #f44336;
            margin-top: 5px;
        }

        .remove-photo-btn:hover {
            background: #d32f2f;
        }

        .remove-photo-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .camera-btn {
            background: #9C27B0;
            margin-top: 10px;
        }

        .camera-btn:hover {
            background: #7B1FA2;
        }

        .camera-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .camera-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
        }

        .camera-modal.active {
            display: flex;
        }

        .camera-container {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 8px;
            max-width: 90%;
            max-height: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .camera-container h2 {
            color: #9C27B0;
            margin-top: 0;
            margin-bottom: 20px;
        }

        .camera-video-container {
            position: relative;
            width: 640px;
            max-width: 100%;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }

        .camera-video {
            width: 100%;
            height: auto;
            display: block;
            transform: scaleX(-1);
        }

        .camera-canvas {
            display: none;
        }

        .camera-controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .camera-controls button {
            width: auto;
            min-width: 150px;
            padding: 12px 25px;
        }

        .capture-btn {
            background: #4CAF50;
        }

        .capture-btn:hover {
            background: #45a049;
        }

        .cancel-camera-btn {
            background: #f44336;
        }

        .cancel-camera-btn:hover {
            background: #d32f2f;
        }

        .camera-status {
            color: #888;
            margin-top: 10px;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .camera-video-container {
                width: 100%;
            }

            .camera-container {
                padding: 20px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>
            Piste Management
            <span id="mqtt-status" class="connection-status disconnected">Disconnected</span>
        </h1>

        <div class="nav-links">
            <a href="/" class="nav-link">‚Üê Display</a>
            <a href="/admin" class="nav-link">Admin Panel</a>
        </div>

        <div class="form-section">
            <div class="form-group full-width">
                <label for="piste-number">Piste Number:</label>
                <input type="text" id="piste-number" placeholder="001" maxlength="3">
                <div class="info-text">Enter 3-digit piste number (e.g., 001, 012, 123)</div>
            </div>

            <div class="form-row">
                <div class="fencer-section">
                    <h3>Left Fencer</h3>
                    <div class="form-group">
                        <label for="left-name">Name:</label>
                        <input type="text" id="left-name" placeholder="Fencer Name">
                    </div>
                    <div class="form-group">
                        <label for="left-nationality">Nationality (NOC Code):</label>
                        <input type="text" id="left-nationality" placeholder="USA" maxlength="3"
                            style="text-transform: uppercase;">
                        <div class="info-text">3-letter NOC code (e.g., USA, FRA, GER)</div>
                    </div>
                    <div class="photo-upload-group">
                        <label>Photo:</label>
                        <div class="photo-preview" id="left-preview">
                            <div class="photo-preview-empty">No photo selected</div>
                        </div>
                        <div class="file-input-wrapper">
                            <input type="file" id="left-photo" accept="image/*">
                            <label for="left-photo" class="file-input-label">Choose Photo</label>
                        </div>
                        <button class="camera-btn" onclick="openCamera('left')">üì∑ Take Photo with Camera</button>
                        <div class="zoom-controls">
                            <label>Zoom:</label>
                            <input type="range" class="zoom-slider" id="left-zoom" min="100" max="300" value="100"
                                disabled>
                            <span class="zoom-value" id="left-zoom-value">100%</span>
                            <button class="reset-btn" onclick="resetImage('left')" disabled
                                id="left-reset-btn">Reset</button>
                        </div>
                        <div class="info-text">Drag image to reposition, use slider to zoom</div>
                        <button class="upload-photo-btn" onclick="uploadPhoto('left')" disabled
                            id="left-upload-btn">Upload Photo</button>
                        <button class="remove-photo-btn" onclick="removePhoto('left')">Remove Photo</button>
                    </div>
                </div>

                <div class="fencer-section">
                    <h3>Right Fencer</h3>
                    <div class="form-group">
                        <label for="right-name">Name:</label>
                        <input type="text" id="right-name" placeholder="Fencer Name">
                    </div>
                    <div class="form-group">
                        <label for="right-nationality">Nationality (NOC Code):</label>
                        <input type="text" id="right-nationality" placeholder="USA" maxlength="3"
                            style="text-transform: uppercase;">
                        <div class="info-text">3-letter NOC code (e.g., USA, FRA, GER)</div>
                    </div>
                    <div class="photo-upload-group">
                        <label>Photo:</label>
                        <div class="photo-preview" id="right-preview">
                            <div class="photo-preview-empty">No photo selected</div>
                        </div>
                        <div class="file-input-wrapper">
                            <input type="file" id="right-photo" accept="image/*">
                            <label for="right-photo" class="file-input-label">Choose Photo</label>
                        </div>
                        <button class="camera-btn" onclick="openCamera('right')">üì∑ Take Photo with Camera</button>
                        <div class="zoom-controls">
                            <label>Zoom:</label>
                            <input type="range" class="zoom-slider" id="right-zoom" min="100" max="300" value="100"
                                disabled>
                            <span class="zoom-value" id="right-zoom-value">100%</span>
                            <button class="reset-btn" onclick="resetImage('right')" disabled
                                id="right-reset-btn">Reset</button>
                        </div>
                        <div class="info-text">Drag image to reposition, use slider to zoom</div>
                        <button class="upload-photo-btn" onclick="uploadPhoto('right')" disabled
                            id="right-upload-btn">Upload Photo</button>
                        <button class="remove-photo-btn" onclick="removePhoto('right')">Remove Photo</button>
                    </div>
                </div>
            </div>

            <button id="send-btn" onclick="sendData()" disabled>Send to Piste</button>
            <button class="secondary" onclick="clearForm()">Clear Form</button>
        </div>

        <div id="status-message" class="status"></div>
    </div>

    <!-- Camera Modal -->
    <div id="camera-modal" class="camera-modal">
        <div class="camera-container">
            <h2>Take Photo</h2>
            <div class="camera-video-container">
                <video id="camera-video" class="camera-video" autoplay playsinline></video>
            </div>
            <canvas id="camera-canvas" class="camera-canvas"></canvas>
            <div class="camera-status" id="camera-status">Initializing camera...</div>
            <div class="camera-controls">
                <button class="capture-btn" onclick="capturePhoto()" id="capture-btn" disabled>Capture Photo</button>
                <button class="cancel-camera-btn" onclick="closeCamera()">Cancel</button>
            </div>
        </div>
    </div>

    <script src="/js/mqttws31.min.js"></script>
    <script>
        let client;

        // Connect to MQTT using Paho
        function connectMQTT() {
            try {
                // Use wss:// (secure websocket) when page is loaded via https://
                const useSSL = location.protocol === 'https:';
                const port = useSSL ? 9002 : 9001;  // Use port 9002 for wss, 9001 for ws
                client = new Paho.MQTT.Client(location.hostname, port, "pisteMgt_" + Date.now());

                client.onConnectionLost = (responseObject) => {
                    if (responseObject.errorCode !== 0) {
                        console.log("Connection lost: " + responseObject.errorMessage);
                        updateStatus('disconnected');
                        showMessage('Connection lost: ' + responseObject.errorMessage, 'error');
                    }
                };

                client.connect({
                    useSSL: useSSL,
                    onSuccess: () => {
                        console.log('Connected to MQTT broker');
                        updateStatus('connected');
                        showMessage('Connected to MQTT broker', 'success');
                    },
                    onFailure: (err) => {
                        console.error('Connection failed:', err);
                        updateStatus('disconnected');
                        showMessage('Connection failed: ' + err.errorMessage, 'error');
                    }
                });

            } catch (error) {
                console.error('Connection error:', error);
                updateStatus('disconnected');
                showMessage('Failed to connect: ' + error.message, 'error');
            }
        }

        function updateStatus(status) {
            const statusEl = document.getElementById('mqtt-status');
            const sendBtn = document.getElementById('send-btn');

            statusEl.textContent = status === 'connected' ? 'Connected' : 'Disconnected';
            statusEl.className = 'connection-status ' + status;
            sendBtn.disabled = status !== 'connected';
        }

        function showMessage(message, type) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + type;
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        function validateForm() {
            const pisteNumber = document.getElementById('piste-number').value.trim();
            const leftName = document.getElementById('left-name').value.trim();
            const leftNationality = document.getElementById('left-nationality').value.trim().toUpperCase();
            const rightName = document.getElementById('right-name').value.trim();
            const rightNationality = document.getElementById('right-nationality').value.trim().toUpperCase();

            if (!pisteNumber) {
                showMessage('Please enter a piste number', 'error');
                return null;
            }

            if (!leftName || !leftNationality) {
                showMessage('Please enter left fencer name and nationality', 'error');
                return null;
            }

            if (!rightName || !rightNationality) {
                showMessage('Please enter right fencer name and nationality', 'error');
                return null;
            }

            if (leftNationality.length !== 3 || rightNationality.length !== 3) {
                showMessage('Nationality codes must be exactly 3 letters', 'error');
                return null;
            }

            return {
                pisteNumber: pisteNumber.padStart(3, '0'),
                leftName: leftName,
                leftNationality: leftNationality,
                rightName: rightName,
                rightNationality: rightNationality
            };
        }

        function sendData() {
            if (!client || !client.isConnected()) {
                showMessage('Not connected to MQTT broker', 'error');
                return;
            }

            const data = validateForm();
            if (!data) {
                return;
            }

            try {
                const topic = `MQTT_Cyrano/Piste_${data.pisteNumber}/FromSoftware`;
                const pisteNum = parseInt(data.pisteNumber, 10).toString();

                // First, send ACK message
                const ackPayload = {
                    Protocol: "EFP1.1",
                    Com: "ACK",
                    Piste: pisteNum,
                    Compe: "1"
                };

                const ackMessage = new Paho.MQTT.Message(JSON.stringify(ackPayload));
                ackMessage.destinationName = topic;
                client.send(ackMessage);

                console.log('Published ACK to:', topic, 'Payload:', ackPayload);
                showMessage(`Sending ACK to piste ${data.pisteNumber}...`, 'success');

                // Wait 1 second, then send DISP message
                setTimeout(() => {
                    const dispPayload = {
                        Protocol: "EFP1.1",
                        Com: "DISP",
                        Piste: pisteNum,
                        Compe: "1",
                        RightName: data.rightName,
                        RightNat: data.rightNationality,
                        LeftName: data.leftName,
                        LeftNat: data.leftNationality
                    };

                    const dispMessage = new Paho.MQTT.Message(JSON.stringify(dispPayload));
                    dispMessage.destinationName = topic;
                    client.send(dispMessage);

                    showMessage(`Data sent to piste ${data.pisteNumber}`, 'success');
                    console.log('Published DISP to:', topic, 'Payload:', dispPayload);
                }, 1000);

            } catch (error) {
                showMessage('Failed to send: ' + error.message, 'error');
            }
        }

        function clearForm() {
            document.getElementById('piste-number').value = '';
            document.getElementById('left-name').value = '';
            document.getElementById('left-nationality').value = '';
            document.getElementById('right-name').value = '';
            document.getElementById('right-nationality').value = '';
            showMessage('Form cleared', 'success');
        }

        // Auto-uppercase nationality codes
        document.getElementById('left-nationality').addEventListener('input', (e) => {
            e.target.value = e.target.value.toUpperCase();
        });

        document.getElementById('right-nationality').addEventListener('input', (e) => {
            e.target.value = e.target.value.toUpperCase();
        });

        // Photo preview and upload functionality with zoom/pan
        const imageState = {
            left: { scale: 1, offsetX: 0, offsetY: 0, img: null, isDragging: false, startX: 0, startY: 0 },
            right: { scale: 1, offsetX: 0, offsetY: 0, img: null, isDragging: false, startX: 0, startY: 0 }
        };

        function setupPhotoInput(position) {
            const input = document.getElementById(`${position}-photo`);
            const preview = document.getElementById(`${position}-preview`);
            const uploadBtn = document.getElementById(`${position}-upload-btn`);
            const zoomSlider = document.getElementById(`${position}-zoom`);
            const zoomValue = document.getElementById(`${position}-zoom-value`);
            const resetBtn = document.getElementById(`${position}-reset-btn`);

            input.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = new Image();
                        img.onload = () => {
                            imageState[position].img = img;
                            resetImage(position);
                            uploadBtn.disabled = false;
                            zoomSlider.disabled = false;
                            resetBtn.disabled = false;
                            setupDragHandlers(position);
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                } else {
                    preview.innerHTML = '<div class="photo-preview-empty">No photo selected</div>';
                    uploadBtn.disabled = true;
                    zoomSlider.disabled = true;
                    resetBtn.disabled = true;
                    imageState[position].img = null;
                }
            });

            // Zoom slider handler
            zoomSlider.addEventListener('input', (e) => {
                imageState[position].scale = e.target.value / 100;
                zoomValue.textContent = e.target.value + '%';
                updatePreview(position);
            });
        }

        function setupDragHandlers(position) {
            const preview = document.getElementById(`${position}-preview`);
            const img = preview.querySelector('img');

            if (!img) return;

            img.addEventListener('mousedown', (e) => {
                e.preventDefault();
                imageState[position].isDragging = true;
                imageState[position].startX = e.clientX - imageState[position].offsetX;
                imageState[position].startY = e.clientY - imageState[position].offsetY;
                img.style.cursor = 'grabbing';
            });

            document.addEventListener('mousemove', (e) => {
                if (imageState[position].isDragging) {
                    imageState[position].offsetX = e.clientX - imageState[position].startX;
                    imageState[position].offsetY = e.clientY - imageState[position].startY;
                    updatePreview(position);
                }
            });

            document.addEventListener('mouseup', () => {
                if (imageState[position].isDragging) {
                    imageState[position].isDragging = false;
                    const img = preview.querySelector('img');
                    if (img) img.style.cursor = 'move';
                }
            });
        }

        function updatePreview(position) {
            const preview = document.getElementById(`${position}-preview`);
            const img = preview.querySelector('img');

            if (!img) return;

            const scale = imageState[position].scale;
            const offsetX = imageState[position].offsetX;
            const offsetY = imageState[position].offsetY;

            img.style.transform = `scale(${scale}) translate(${offsetX / scale}px, ${offsetY / scale}px)`;
        }

        function resetImage(position) {
            const preview = document.getElementById(`${position}-preview`);
            const state = imageState[position];

            state.scale = 1;
            state.offsetX = 0;
            state.offsetY = 0;

            const zoomSlider = document.getElementById(`${position}-zoom`);
            const zoomValue = document.getElementById(`${position}-zoom-value`);
            zoomSlider.value = 100;
            zoomValue.textContent = '100%';

            if (state.img) {
                preview.innerHTML = `<img src="${state.img.src}" alt="${position} fencer">`;
                updatePreview(position);
                setupDragHandlers(position);
            }
        }

        async function uploadPhoto(position) {
            const pisteNumber = document.getElementById('piste-number').value.trim();
            if (!pisteNumber) {
                showMessage('Please enter a piste number first', 'error');
                return;
            }

            const paddedPiste = pisteNumber.padStart(3, '0');
            const state = imageState[position];

            if (!state.img) {
                showMessage('Please select a photo first', 'error');
                return;
            }

            // Create canvas to crop the image
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            // Set canvas to match display size (4:5 aspect ratio)
            const displayWidth = 200;
            const displayHeight = 250;
            canvas.width = displayWidth;
            canvas.height = displayHeight;

            // Calculate source dimensions based on zoom and pan
            const scale = state.scale;
            const offsetX = state.offsetX;
            const offsetY = state.offsetY;

            // Draw the transformed image onto canvas
            ctx.fillStyle = '#222';
            ctx.fillRect(0, 0, displayWidth, displayHeight);

            // Calculate how the image fits with object-fit: cover
            const imgAspect = state.img.width / state.img.height;
            const containerAspect = displayWidth / displayHeight;

            let drawWidth, drawHeight, drawX, drawY;

            if (imgAspect > containerAspect) {
                // Image is wider - fit to height
                drawHeight = displayHeight;
                drawWidth = drawHeight * imgAspect;
                drawX = (displayWidth - drawWidth) / 2;
                drawY = 0;
            } else {
                // Image is taller - fit to width
                drawWidth = displayWidth;
                drawHeight = drawWidth / imgAspect;
                drawX = 0;
                drawY = (displayHeight - drawHeight) / 2;
            }

            // Apply scale and offset
            const scaledWidth = drawWidth * scale;
            const scaledHeight = drawHeight * scale;
            const scaledX = drawX + offsetX + (drawWidth - scaledWidth) / 2;
            const scaledY = drawY + offsetY + (drawHeight - scaledHeight) / 2;

            ctx.drawImage(state.img, scaledX, scaledY, scaledWidth, scaledHeight);

            // Convert canvas to blob
            canvas.toBlob(async (blob) => {
                const formData = new FormData();
                formData.append('image', blob, 'fencer.jpg');
                formData.append('pisteNumber', paddedPiste);
                formData.append('position', position);

                try {
                    const response = await fetch('/upload-fencer-image', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (response.ok) {
                        showMessage(`${position.charAt(0).toUpperCase() + position.slice(1)} fencer photo uploaded successfully`, 'success');
                    } else {
                        showMessage('Upload failed: ' + result.error, 'error');
                    }
                } catch (error) {
                    showMessage('Upload failed: ' + error.message, 'error');
                }
            }, 'image/jpeg', 0.9);
        }

        async function removePhoto(position) {
            const pisteNumber = document.getElementById('piste-number').value.trim();
            if (!pisteNumber) {
                showMessage('Please enter a piste number first', 'error');
                return;
            }

            const paddedPiste = pisteNumber.padStart(3, '0');

            if (!confirm(`Remove ${position} fencer photo for piste ${paddedPiste}?`)) {
                return;
            }

            try {
                const response = await fetch(`/delete-fencer-image/${paddedPiste}/${position}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage(`${position.charAt(0).toUpperCase() + position.slice(1)} fencer photo removed`, 'success');
                    // Clear the preview and input
                    document.getElementById(`${position}-photo`).value = '';
                    document.getElementById(`${position}-preview`).innerHTML = '<div class="photo-preview-empty">No photo selected</div>';
                    document.getElementById(`${position}-upload-btn`).disabled = true;
                } else {
                    showMessage('Remove failed: ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('Remove failed: ' + error.message, 'error');
            }
        }

        // Camera functionality
        let cameraStream = null;
        let currentCameraPosition = null;

        async function openCamera(position) {
            currentCameraPosition = position;
            const modal = document.getElementById('camera-modal');
            const video = document.getElementById('camera-video');
            const statusEl = document.getElementById('camera-status');
            const captureBtn = document.getElementById('capture-btn');

            modal.classList.add('active');
            statusEl.textContent = 'Requesting camera access...';
            captureBtn.disabled = true;

            try {
                // Request camera access
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    },
                    audio: false
                });

                video.srcObject = cameraStream;

                // Wait for video to be ready
                video.onloadedmetadata = () => {
                    statusEl.textContent = 'Camera ready - Position yourself and click Capture';
                    captureBtn.disabled = false;
                };

            } catch (error) {
                console.error('Camera access error:', error);
                statusEl.textContent = 'Camera access denied or unavailable';
                showMessage('Unable to access camera: ' + error.message, 'error');
            }
        }

        function closeCamera() {
            const modal = document.getElementById('camera-modal');
            const video = document.getElementById('camera-video');
            const statusEl = document.getElementById('camera-status');
            const captureBtn = document.getElementById('capture-btn');

            // Stop camera stream
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }

            video.srcObject = null;
            modal.classList.remove('active');
            statusEl.textContent = 'Initializing camera...';
            captureBtn.disabled = true;
            currentCameraPosition = null;
        }

        function capturePhoto() {
            if (!currentCameraPosition) {
                showMessage('No position selected', 'error');
                return;
            }

            const video = document.getElementById('camera-video');
            const canvas = document.getElementById('camera-canvas');
            const ctx = canvas.getContext('2d');

            // Set canvas size to video dimensions
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Draw video frame to canvas (flip horizontally to match preview)
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            ctx.setTransform(1, 0, 0, 1, 0, 0);

            // Convert canvas to blob
            canvas.toBlob((blob) => {
                if (!blob) {
                    showMessage('Failed to capture photo', 'error');
                    return;
                }

                // Create a File object from the blob
                const file = new File([blob], 'camera-photo.jpg', { type: 'image/jpeg' });

                // Create a DataTransfer to set the file input
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);

                // Set the file input
                const fileInput = document.getElementById(`${currentCameraPosition}-photo`);
                fileInput.files = dataTransfer.files;

                // Trigger the change event to update preview
                const event = new Event('change', { bubbles: true });
                fileInput.dispatchEvent(event);

                // Close camera modal
                closeCamera();
                showMessage('Photo captured successfully', 'success');

            }, 'image/jpeg', 0.9);
        }

        // Close camera modal when clicking outside the container
        document.getElementById('camera-modal').addEventListener('click', (e) => {
            if (e.target.id === 'camera-modal') {
                closeCamera();
            }
        });

        setupPhotoInput('left');
        setupPhotoInput('right');

        // Initialize connection on page load
        window.addEventListener('load', () => {
            connectMQTT();
        });
    </script>
</body>

</html>